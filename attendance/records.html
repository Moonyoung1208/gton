<?php
// records.html 파일 상단

session_start();

if (!isset($_SESSION['user_id']) || $_SESSION['logged_in'] !== TRUE) {
    header("Location: ./index.html"); 
    exit;
}

require_once 'config.php';

$current_user_id = $_SESSION['user_id'];
$user_name = $_SESSION['user_name'];
$user_id = $_SESSION['user_id']; 
$current_date = date("Y-m-d");

// 1. GET 파라미터 및 기본값 설정 (일주일 전 ~ 오늘)
$statusFilter = $_GET['status'] ?? '전체';
if (isset($_GET['status']) && $_GET['status'] === '') {
    $statusFilter = ''; 
}

$today = date('Y-m-d');
$oneWeekAgo = date('Y-m-d', strtotime('-7 days')); 
// URL에 파라미터가 없으면 '일주일 전'부터 '오늘'까지를 기본값으로 사용
$currentStartDate = $_GET['startDate'] ?? $oneWeekAgo; 
$currentEndDate = $_GET['endDate'] ?? $today;     

$records = [];
$conn = @connectDB();

if (!$conn) {
    echo "<p class='error-message'>데이터베이스 연결에 실패했습니다.</p>";
} elseif ($statusFilter === '') {
    // $records는 빈 배열로 유지되어 아래 HTML에서 안내 문구가 표시됩니다.
    if ($conn) {
    $conn->close(); // 불필요한 DB 연결 닫기
    }
} else {
    // 2. DB 상태 코드로 변환 및 SQL 쿼리 조건 설정
    $dbStatus = null;
    
    // 기본 조건: user_id와 날짜 범위 (필수)
    $types = "iss"; // user_id(i), startDate(s), endDate(s)
    $params = [$current_user_id, $currentStartDate, $currentEndDate];
    $sql_conditions = "user_id = ? AND work_date BETWEEN ? AND ?";

    // 상태 필터 추가 (선택적)
    if ($statusFilter !== '전체') {
        switch ($statusFilter) {
            case '정상': $dbStatus = 'normal'; break;
            case '지각': $dbStatus = 'late'; break;
            case '조퇴': $dbStatus = 'early'; break;
            case '결근': $dbStatus = 'absent'; break;
        }
        
        if ($dbStatus) {
            // 상태 필터 조건 추가
            $sql_conditions .= " AND status = ?";
            $types .= "s"; // status (string) 추가
            $params[] = $dbStatus; 
        }
    }


    // 3. SQL 쿼리 작성 (날짜 + 상태 모두 적용)
    $sql = "
        SELECT 
            work_date, check_in_time, check_out_time, work_hours, status
        FROM 
            records
        WHERE 
            {$sql_conditions} 
        ORDER BY work_date DESC
        LIMIT 5
    ";

    $stmt = $conn->prepare($sql);
    
    // 4. 파라미터 바인딩 및 실행
    $stmt->bind_param($types, ...$params); 
    $stmt->execute();
    $result = $stmt->get_result();
    
    $statusMap = [
        'normal' => '정상',
        'late' => '지각',
        'early' => '조퇴',
        'absent' => '결근'
    ];
    
    while ($row = $result->fetch_assoc()) {
        $records[] = [
            'date' => $row['work_date'],
            'dayOfWeek' => date('D', strtotime($row['work_date'])), 
            'onTime' => substr($row['check_in_time'], 0, 5) ?? '미등록', 
            'offTime' => $row['check_out_time'] ? substr($row['check_out_time'], 0, 5) : '근무중',
            'workTime' => $row['work_hours'] ?? 'N/A',
            'status' => $statusMap[$row['status']] ?? '오류',
        ];
    }

    $stmt->close();
    $conn->close();
}
?>

<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>근태기록 - 근태ON</title>
    <link rel="stylesheet" href="css/font.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/records.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
        integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
</head>

<body>
    <nav class="nav">
        <ul class="nav-list">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link">
                    <i class="fa-regular fa-house"></i>
                </a>
            </li>
            <li class="nav-item">
                <a href="records.html" class="nav-link active">
                    <i class="fa-regular fa-calendar"></i>
                </a>
            </li>
            <li class="nav-item">
                <a href="statistics.html" class="nav-link">
                    <i class="fa-solid fa-chart-column"></i>
                </a>
            </li>
            <li class="nav-item">
                <a href="mypage.html" class="nav-link">
                    <i class="fa-solid fa-gear"></i>
                </a>
            </li>
        </ul>
    </nav>

    <main class="container">
        <section class="section">
            <h2 class="section-title">근태기록 조회</h2>

            <form action="" method="GET" id="filterForm">

                <div class="filter-row">
                    <!-- 날짜 입력 -->
                    <div class="date-inputs">
                        <div class="form-group">
                            <label class="form-label" for="start-date">시작일</label>
                            <input type="date" id="start-date" name="startDate" class="form-input"
                                value="<?= htmlspecialchars($currentStartDate) ?>">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="end-date">종료일</label>
                            <input type="date" id="end-date" name="endDate" class="form-input"
                                value="<?= htmlspecialchars($currentEndDate) ?>">
                        </div>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="form-group">
                        <label class="form-label">근무상태</label>
                        <div class="filter-chips" role="group" aria-label="근무상태">
                            <button type="button" class="chip <?= ($statusFilter === '전체') ? 'active' : '' ?>"
                                data-value="전체">전체</button>
                            <button type="button" class="chip <?= ($statusFilter === '정상') ? 'active' : '' ?>"
                                data-value="정상">정상</button>
                            <button type="button" class="chip <?= ($statusFilter === '지각') ? 'active' : '' ?>"
                                data-value="지각">지각</button>
                            <button type="button" class="chip <?= ($statusFilter === '조퇴') ? 'active' : '' ?>"
                                data-value="조퇴">조퇴</button>
                            <button type="button" class="chip <?= ($statusFilter === '결근') ? 'active' : '' ?>"
                                data-value="결근">결근</button>
                        </div>
                        <input type="hidden" name="status" id="statusFilter"
                            value="<?= htmlspecialchars($_GET['status'] ?? '전체') ?>">
                    </div>
                    <!-- <div class="form-group">
                        <button type="submit" class="btn btn-secondary" id="searchButton"
                            style="width: 100%;">조회하기</button>
                    </div> -->
                </div>
            </form>

            <!-- 근무상태 -->
            <!-- <div class="form-group">
                        <label class="form-label">근무상태</label>
                        <div class="filter-chips" role="group" aria-label="근무상태">
                            <button type="button" class="chip active" data-value="전체">전체</button>
                            <button type="button" class="chip" data-value="정상">정상</button>
                            <button type="button" class="chip" data-value="지각">지각</button>
                            <button type="button" class="chip" data-value="조퇴">조퇴</button>
                            <button type="button" class="chip" data-value="결근">결근</button>
                        </div>
                    </div> -->

            <!-- 조회 -->
            <!-- <div class="form-group">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">조회하기</button>
                    </div> -->

            </div>
            </form>

        </section>

        <section class="section">

            <h2 class="section-title">조회 결과</h2>

            <?php if (empty($records)): ?>
            <p class="no-results">조회된 근태 기록이 없습니다.</p>
            <?php else: ?>

            <?php
            foreach ($records as $record): 
            $badgeClass = match ($record['status']) {
            '정상' => 'badge-success',
            '지각', '조퇴' => 'badge-warning',
            '결근' => 'badge-danger',
            default => 'badge-secondary',
            };
            ?>

            <div class="result-card card">
                <div class="result-date">
                    <?= htmlspecialchars($record['date']) ?> (<?= htmlspecialchars($record['dayOfWeek']) ?>)
                </div>
                <div class="grid grid-2">
                    <div class="result-on">출근: <span>
                            <?= htmlspecialchars($record['onTime']) ?>
                        </span></div>
                    <div class="result-off">퇴근: <span>
                            <?= htmlspecialchars($record['offTime']) ?>
                        </span></div>
                    <div class="result-time">근무시간:
                        <?= htmlspecialchars($record['workTime']) ?>
                    </div>
                    <div class="result-status"><span class="badge <?= htmlspecialchars($badgeClass) ?>">
                            <?= htmlspecialchars($record['status']) ?>
                        </span></div>
                </div>
            </div>

            <?php endforeach; ?>
            <?php endif; ?>

        </section>
    </main>
    <script src="./js/record.js"></script>
</body>

</html>