<?php
session_start();
require_once '../config.php'; 

// 관리자 로그인 상태 확인
if (!isset($_SESSION['admin_logged_in']) || $_SESSION['admin_logged_in'] !== TRUE) {
    header("Location: admin-login.html");
    exit;
}

$conn = connectDB();

// 이전 입력 데이터 가져오기
$f = $_SESSION['form_data'] ?? [];
unset($_SESSION['form_data']);

// DB에서 부서 목록 가져오기
$dept_sql = "SELECT id, dept_name FROM departments ORDER BY dept_name ASC";
$dept_result = $conn->query($dept_sql);

?>

<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>직원 추가 - 근태ON</title>
    <link rel="stylesheet" href="../css/font.css">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="css/admin.css">
    <!-- <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
</head>

<body>
    <div class="admin-menu">
        <div class="admin-nav-link" onclick="history.back()">
            <i class="fa-solid fa-chevron-left"></i>
        </div>
    </div>

    <div class="sidebar-overlay" id="overlay"></div>
    <main class="container">
        <form class="add-employee-form" action="add_employee_process.php" method="POST">
            <section class="section">
                <h2 class="section-title">기본 정보</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">이름 <span class="required">*</span></label>
                        <input type="text" name="name" class="form-input"
                            value="<?php echo htmlspecialchars($f['name'] ?? ''); ?>" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">이메일 <span class="required">*</span></label>
                        <input type="email" name="email" class="form-input"
                            value="<?php echo htmlspecialchars($f['email'] ?? ''); ?>" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">연락처 <span class="required">*</span></label>
                        <input type="tel" id="phone" name="phone" class="form-input"
                            value="<?php echo htmlspecialchars($f['phone'] ?? ''); ?>" maxlength="13">
                    </div>
                    <div class="form-group">
                        <label class="form-label">부서 <span class="required">*</span></label>
                        <select name="dept_id" class="form-input" required>
                            <option value="">부서를 선택하세요</option>
                            <?php 
                            if ($dept_result->num_rows > 0) {
                                while($row = $dept_result->fetch_assoc()) {
                                // 이전에 선택했던 값이 있다면 selected 처리 (에러로 돌아왔을 때 대비)
                                $selected = (isset($f['dept_id']) && $f['dept_id'] == $row['id']) ? 'selected' : '';
                                echo "<option value='{$row['id']}' {$selected}>{$row['dept_name']}</option>";
                                }
                            }
                            ?>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">직급</label>
                        <input type="text" name="position" class="form-input"
                            value="<?php echo htmlspecialchars($f['position'] ?? ''); ?>">
                    </div>
                    <div class="form-group">
                        <label class="form-label">입사일</label>
                        <input type="date" name="join_date" class="form-input"
                            value="<?php echo htmlspecialchars($f['join_date'] ?? ''); ?>">
                    </div>
                </div>
            </section>

            <section class="section">
                <h2 class="section-title">계정 정보</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">계정 아이디 <span class="required">*</span></label>
                        <input type="text" name="username" class="form-input"
                            value="<?php echo htmlspecialchars($f['username'] ?? ''); ?>" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">임시 비밀번호 <span class="required">*</span></label>
                        <input type="password" name="password" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">비밀번호 확인 <span class="required">*</span></label>
                        <input type="password" name="password_confirm" class="form-input" required>
                    </div>
                </div>
            </section>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary full" onclick="history.back()">취소</button>
                <button type="submit" class="btn btn-primary full"><i class="fa-solid fa-user-plus"></i> 직원 추가</button>
            </div>
        </form>
    </main>

    <?php if (isset($_SESSION['status'])): ?>
    <script>
        Swal.fire({
            icon: '<?php echo $_SESSION['status']; ?>',
            title: '<?php echo $_SESSION['status'] === 'success' ? '성공' : '알림'; ?>',
            text: '<?php echo $_SESSION['msg']; ?>',
            confirmButtonColor: '#4e73df',
            width: '90%',
            maxWidth: '400px',
            customClass: {
                container: 'my-swal-container'
            }
        });
    </script>
    <?php 
        unset($_SESSION['status']);
        unset($_SESSION['msg']);
    ?>
    <?php endif; ?>

    <script src="./js/nav.js"></script>
    <script>
        // 전화번호 하이픈 로직 (기존 유지)
        const phoneInput = document.getElementById("phone");
        phoneInput.addEventListener("input", function () {
            this.value = this.value.replace(/[^0-9]/g, "")
                .replace(/^(\d{2,3})(\d{3,4})(\d{4})$/, `$1-$2-$3`);
        });
    </script>
</body>

</html>