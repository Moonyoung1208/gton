<?php
session_start();

if (!isset($_SESSION['user_id']) || $_SESSION['logged_in'] !== TRUE) {
    // 세션에 user_id가 없거나 logged_in 상태가 아니면 로그인 페이지로 이동
    header("Location: ./index.html"); 
    exit;
}

require_once 'config.php'; 

$user_name = $_SESSION['user_name'];
$user_id = $_SESSION['user_id']; 
$current_date = date("Y-m-d");

$conn = connectDB(); 

// 1. 오늘 날짜의 출근 기록 조회
$record = null;
$sql = "SELECT check_in_time, check_in_location, check_out_time, status, work_hours
        FROM records 
        WHERE user_id = ? AND work_date = ?";
$stmt = $conn->prepare($sql);
$stmt->bind_param("is", $user_id, $current_date);
$stmt->execute();
$result = $stmt->get_result();

if ($result->num_rows === 1) {
    // 오늘 기록이 있다면 데이터를 가져옵니다.
    $record = $result->fetch_assoc();
}

$stmt->close();

// 2. HTML 출력에 사용할 변수 준비
$display_check_in_time = $record ? $record['check_in_time'] : '--:--';
$display_location = $record ? $record['check_in_location'] : '위치 정보 없음';
$display_status = $record ? $record['status'] : 'not_checked_in';
$display_check_out_time = $record ? ($record['check_out_time'] ?? '--:--') : '--:--';
$display_work_hours = $record ? ($record['work_hours'] ?? 0.00) : 0.00;

// 시간 변환

// 총 근무 시간을 분 단위로 변환 (정수로 반올림)
$total_minutes_int = round($display_work_hours * 60);

// 시와 분을 계산
$hours = floor($total_minutes_int / 60);
$minutes = $total_minutes_int % 60;

//HH:MM 형식으로 포맷
$display_work_duration = sprintf("%02d:%02d", $hours, $minutes);

// 상태 코드를 사용자 친화적인 한글로 변환
$status_map = [
    'late' => '지각',
    'early_leave' => '조퇴',
    'absent' => '결근',
    'normal' => '정상',
    'not_checked_in' => '미출근'
];

$display_status_kor = $status_map[$display_status];

// 3. 이번 달 근태 요약 데이터 준비
$summary_data = [
    'normal_days' => 0,
    'late_days' => 0,
    'total_work_days' => 0,
    'total_work_hours' => 0.00
];

// 이번 달의 시작일과 종료일을 계산
$current_month_start = date('Y-m-01'); // 예: 2025-12-01
$current_month_end = date('Y-m-t');   // 예: 2025-12-31

// SQL을 사용하여 이번 달 기록을 집계
$summary_sql = "SELECT 
                    COUNT(CASE WHEN status = 'working' OR status = 'early_leave' THEN 1 END) AS total_work_days,
                    COUNT(CASE WHEN status = 'late' THEN 1 END) AS late_days,
                    SUM(work_hours) AS total_work_hours
                FROM 
                    records
                WHERE 
                    user_id = ? 
                    AND work_date BETWEEN ? AND ?";

$summary_stmt = $conn->prepare($summary_sql);
$summary_stmt->bind_param("iss", $user_id, $current_month_start, $current_month_end);
$summary_stmt->execute();
$summary_result = $summary_stmt->get_result();

if ($summary_result->num_rows > 0) {
    $raw_summary = $summary_result->fetch_assoc();
        
    $summary_data['late_days'] = (int)$raw_summary['late_days'];
    $summary_data['total_work_days'] = (int)$raw_summary['total_work_days'] + $summary_data['late_days'];
    
    // 정상출근일 = 총 근무일 - 지각일
    $summary_data['normal_days'] = $summary_data['total_work_days'] - $summary_data['late_days'];
    
    // 총 근무시간을 HH:MM 형식으로 포맷
    $raw_total_hours = (float)($raw_summary['total_work_hours'] ?? 0.00);

    // 총 근무시간을 분 단위로 변환
    $total_minutes_int = round($raw_total_hours * 60);

    // 시와 분을 계산
    $hours = floor($total_minutes_int / 60);
    $minutes = $total_minutes_int % 60;

    // HH:mm 형식으로 포맷
    $summary_data['total_work_hours'] = sprintf("%02d:%02d", $hours, $minutes);
}

$summary_stmt->close();

// 최근 출퇴근 기록 데이터 준비
$recent_records = [];

// 가장 최근 5개의 기록을 날짜 내림차순(DESC)으로 조회
$recent_sql = "SELECT 
                    work_date, 
                    check_in_time, 
                    check_out_time, 
                    status
                FROM 
                    records
                WHERE 
                    user_id = ? 
                ORDER BY 
                    work_date DESC 
                LIMIT 5";

$recent_stmt = $conn->prepare($recent_sql);
$recent_stmt->bind_param("i", $user_id);
$recent_stmt->execute();
$recent_result = $recent_stmt->get_result();

// 결과를 배열에 저장
while ($row = $recent_result->fetch_assoc()) {
    $recent_records[] = $row;
}

$recent_stmt->close();

$conn->close();

// 현재 시간 및 날짜
$day_of_week = date('w');
$weekdays = ['일', '월', '화', '수', '목', '금', '토'];
$display_current_date_kor = date("Y년 m월 d일 ") . $weekdays[$day_of_week] . "요일";

// 정상출근율 퍼센테이지 계산
$attendance_percent = 0;
if ($summary_data['total_work_days'] > 0) {
    // (정상출근일 / 총 근무일) * 100
    $attendance_percent = round(($summary_data['normal_days'] / $summary_data['total_work_days']) * 100);
}

?>

<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>대시보드 - 근태ON</title>

    <!-- css -->
    <link rel="stylesheet" href="css/font.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
        integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
</head>

<body>
    <nav class="nav">
        <ul class="nav-list">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link active">
                    <i class="fa-regular fa-house"></i>
                </a>
            </li>
            <li class="nav-item">
                <a href="records.html" class="nav-link">
                    <i class="fa-regular fa-calendar"></i>
                </a>
            </li>
            <li class="nav-item">
                <a href="statistics.html" class="nav-link">
                    <i class="fa-solid fa-chart-column"></i>
                </a>
            </li>
            <li class="nav-item">
                <a href="mypage.html" class="nav-link">
                    <i class="fa-solid fa-gear"></i>
                </a>
            </li>
        </ul>
    </nav>

    <main class="container">
        <section class="section">
            <div class="time-display font-godo">
                <div class="current-time" id="realTime">--:--:--</div>
                <div class="current-date" id="realDate">
                    <?php echo htmlspecialchars($display_current_date_kor); ?>
                </div>
            </div>

            <div class="location-info">
                <i class="fa-solid fa-location-dot"></i>
                <?php echo htmlspecialchars($display_location); ?>
            </div>

            <div class="work-status">
                <div class="status-item card">
                    <div class="status-label">출근시각</div>
                    <div class="status-value">
                        <?php echo htmlspecialchars($display_check_in_time); ?>
                    </div>
                </div>
                <div class="status-item card">
                    <div class="status-label">퇴근시각</div>
                    <div class="status-value">
                        <?php echo htmlspecialchars($display_check_out_time); ?>
                    </div>
                </div>
                <div class="status-item card">
                    <div class="status-label">근무시간</div>
                    <div class="status-value">
                        <?php echo htmlspecialchars($display_work_duration); ?>
                    </div>
                </div>
                <div class="status-item card">
                    <div class="status-label">근무상태</div>
                    <div class="status-value">
                        <?php echo htmlspecialchars($display_status_kor); ?>
                    </div>
                </div>
            </div>


            <div class="work-buttons">
                <form action="check_out_process.php" method="POST">
                    <button class="btn btn-secondary btn-block">퇴근하기</button>
                </form>
                <form action="check_in_process.php" method="POST">
                    <button class="btn btn-primary btn-block">출근하기</button>
                </form>
            </div>

        </section>

        <section class="section">
            <h2 class="section-title">이번 달 근태 요약</h2>
            <!-- 정상 출근율 바 -->
            <div class="progress-wrap">
                <div class="progress-info">
                    <!-- <span class="progress-label">정상출근 달성률</span> -->
                    <span class="progress-percent">
                        정상출근
                        <?= $attendance_percent; ?>%
                    </span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" style="width: <?= $attendance_percent; ?>%;"></div>
                </div>
            </div>

            <div class="summary-grid">
                <div class="summary-item card">
                    <div class="summary-label">정상출근일</div>
                    <div class="summary-value">
                        <?= $summary_data['normal_days']; ?>
                    </div>
                </div>
                <div class="summary-item card">
                    <div class="summary-label">지각일</div>
                    <div class="summary-value">
                        <?= $summary_data['late_days']; ?>
                    </div>
                </div>
                <div class="summary-item card">
                    <div class="summary-label">총 근무일</div>
                    <div class="summary-value">
                        <?= $summary_data['total_work_days']; ?>
                    </div>
                </div>
                <div class="summary-item card">
                    <div class="summary-label">총 근무시간</div>
                    <div class="summary-value">
                        <?= $summary_data['total_work_hours']; ?>
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">최근 출퇴근 기록</h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>근무날짜</th>
                        <th>출근시간</th>
                        <th>퇴근시간</th>
                        <th>근무상태</th>
                    </tr>
                </thead>
                <?php if (empty($recent_records)): ?>
                <tr>
                    <td colspan="4">최근 출퇴근 기록이 없습니다.</td>
                </tr>
                <?php else: ?>
                <?php foreach ($recent_records as $record_item): 
                    // 퇴근 시간 처리: 기록이 없으면 '진행중' 또는 '미입력'으로 표시
                    $out_time = $record_item['check_out_time'] ?? '진행중';
                    
                    // 근무 상태에 따라 뱃지 색상 클래스 결정
                    $badge_class = 'badge-success'; // 기본값: 정상
                    if ($record_item['status'] === 'late' || $record_item['status'] === 'early_leave') {
                        $badge_class = 'badge-warning';
                    } elseif ($record_item['status'] === 'absent' || $record_item['status'] === 'not_checked_in') {
                        $badge_class = 'badge-danger';
                    }
                    
                    // 상태 코드를 한글로 변환 (상단 $status_map 사용)
                    $display_status_kor_table = $status_map[$record_item['status']] ?? $record_item['status'];
                ?>
                <tr>
                    <td>
                        <?= htmlspecialchars($record_item['work_date']); ?>
                    </td>
                    <td>
                        <?= htmlspecialchars($record_item['check_in_time']); ?>
                    </td>
                    <td>
                        <?= htmlspecialchars($out_time); ?>
                    </td>
                    <td><span class="badge <?= $badge_class; ?>">
                            <?= htmlspecialchars($display_status_kor_table); ?>
                        </span></td>
                </tr>
                <?php endforeach; ?>
                <?php endif; ?>
                </tbody>
            </table>
        </section>
    </main>

    <script>
        // 시계 표시
        function updateClock() {
            const now = new Date();

            // 1. 현재 시각 (HH:MM:SS)
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('realTime').textContent = `${hours}:${minutes}:${seconds}`;

            // 2. 현재 날짜 (YYYY년 M월 D일 요일)
            const year = now.getFullYear();
            const month = now.getMonth() + 1; // 0부터 시작하므로 +1
            const date = now.getDate();
            const dayOfWeek = ['일', '월', '화', '수', '목', '금', '토'][now.getDay()];
            document.getElementById('realDate').textContent = `${year}년 ${month}월 ${date}일 ${dayOfWeek}요일`;
        }

        // 함수를 즉시 호출하여 초기 시각을 표시
        updateClock();

        // 1초(1000ms)마다 시각을 업데이트
        setInterval(updateClock, 1000);
    </script>
</body>

</html>