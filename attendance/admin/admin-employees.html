<?php
session_start();

require_once '../config.php';

// 관리자 로그인 확인
if (!isset($_SESSION['admin_logged_in']) || $_SESSION['admin_logged_in'] !== TRUE) {
    header("Location: admin-login.html");
    exit;
}

$conn = connectDB();

// 직원 목록 가져오기
$sql = "SELECT 
            u.user_id, 
            u.name, 
            u.username, 
            u.email, 
            u.phone, 
            d.dept_name, 
            u.position, 
            u.join_date, 
            u.status 
        FROM users u
        LEFT JOIN departments d ON u.dept_id = d.id
        ORDER BY u.join_date DESC";

$result = $conn->query($sql);

?>

<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>직원 관리 - 근태ON</title>
    <link rel="stylesheet" href="../css/font.css">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="css/employee.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
        integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
</head>

<body>
    <div class="admin-menu">
        <div class="admin-nav-link">
            <i class="fa-solid fa-bars" id="menuOpen"></i>
        </div>
    </div>

    <nav class="admin-nav" id="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-title font-godo">관리자 메뉴</span>
            <i class="fa-solid fa-xmark" id="menuClose"></i>
        </div>

        <ul class="admin-nav-list">
            <li class="admin-nav-item">
                <a href="admin-dashboard.html" class="admin-nav-link">
                    <i class="fa-solid fa-chart-line"></i> 대시보드
                </a>
            </li>
            <li class="admin-nav-item">
                <a href="admin-employees.html" class="admin-nav-link active">
                    <i class="fa-solid fa-users"></i> 직원관리
                </a>
            </li>
            <li class="admin-nav-item">
                <a href="admin-records.html" class="admin-nav-link ">
                    <i class="fa-solid fa-calendar-days"></i> 부서관리
                </a>
            </li>
            <li class="admin-nav-item">
                <a href="admin-settings.html" class="admin-nav-link">
                    <i class="fa-solid fa-gear"></i> 전체설정
                </a>
            </li>
        </ul>

        <div class="sidebar-footer">
            <a href="logout.php" class="logout-btn">
                <i class="fa-solid fa-right-from-bracket"></i> 로그아웃
            </a>
        </div>
    </nav>

    <div class="sidebar-overlay" id="overlay"></div>


    <main class="container">
        <header class="page-header">
            <h1 class="section-title">직원 관리</h1>
            <a href="add-employee.html" class="btn btn-primary full">
                <i class="fa-solid fa-user-plus"></i> 직원 추가
            </a>
        </header>

        <div class="setting-item">
            <div class="stat-label">전체 직원</div>
            <div class="stat-value">
                <?php echo $result->num_rows; ?>명
            </div>
        </div>

        <section class="section">
            <div class="employee-list">
                <?php if ($result->num_rows > 0): ?>
                <?php while($row = $result->fetch_assoc()): ?>
                <div class="employee-card" onclick="viewDetail(<?php echo $row['user_id']; ?>)">
                    <div class="emp-info-group">
                        <div class="emp-row">
                            <span class="emp-label">성명</span>
                            <span class="emp-value"><strong>
                                    <?php echo htmlspecialchars($row['name']); ?>
                                </strong></span>
                        </div>
                        <div class="emp-row">
                            <span class="emp-label">이메일</span>
                            <span class="emp-value">
                                <?php echo htmlspecialchars($row['email']); ?>
                            </span>
                        </div>
                        <div class="emp-row">
                            <span class="emp-label">부서/직급</span>
                            <span class="emp-value">
                                <?php echo htmlspecialchars($row['dept_name'] ?? '미지정'); ?> /
                                <?php echo htmlspecialchars($row['position']); ?>
                            </span>
                        </div>
                        <div class="emp-row">
                            <span class="emp-label">입사일</span>
                            <span class="emp-value">
                                <?php echo $row['join_date']; ?>
                            </span>
                        </div>
                    </div>

                    <div class="emp-status-actions">
                        <?php if($row['status'] == 'active'): ?>
                        <span class="badge badge-success">재직</span>
                        <?php else: ?>
                        <span class="badge badge-danger">퇴사</span>
                        <?php endif; ?>
                    </div>
                </div>
                <?php endwhile; ?>
                <?php else: ?>
                <div class="empty-state">등록된 직원이 없습니다.</div>
                <?php endif; ?>
            </div>
        </section>
    </main>

    <script>
        function viewDetail(userId) {
            location.href = `detail-employee.html?id=${userId}`;
        }
    </script>
    <script src="./js/nav.js"></script>
</body>

</html>